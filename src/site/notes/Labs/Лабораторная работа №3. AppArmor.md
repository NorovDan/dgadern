---
{"dg-publish":true,"permalink":"/labs/laboratornaya-rabota-3-app-armor/"}
---


---

**ФИО:** 2022-ФГиИБ-ИБ-1б Воронов Даниил Алексеевич 

---

### 1. Проверка _complain_ и _enforce_ режимов

**1.1. Создайте копию утилиты `ping` (из директории `/bin/`), а вместо нее скопируйте утилиту `cp` (`/bin/cp -> /bin/ping`). После этого переведите профиль `bin.ping` в режим `enforce`. Создайте в домашней директории файл и попробуйте его скопировать с помощью утилиты `ping` (которая, по факту, является копией утилиты `cp`).**

![Pasted image 20250302214108.png](/img/user/Pasted%20image%2020250302214108.png)
<div style="text-align: center;">
  Рисунок 1 - 
</div>

Создаём бэкап утилиты `ping`, чтобы потом вернуть её на место. З
Переводим профиль `bin.ping` в режим `enforce`посредством команды `sudo aa-enforce /etc/apparmour.d/bin.ping` Таким образом мы можем ограничивать нежелательные или же случайные ненужные действия приложений, предотвращая осуществление этих действий.
Создаём для теста файл, записываем в него  информацию, а после пытаемся подменённой утилитой `ping` скопировать файл целиком и сделать его новую копию, то мы получим ошибку, так как нет разрешения

Объясните, что произошло. Посмотрите журнал, что там за сообщения (относительно этой операции), что они значат?

![Pasted image 20250302214146.png](/img/user/Pasted%20image%2020250302214146.png)
<div style="text-align: center;">
  Рисунок 2 - Журнал логов
</div>

Логи находятся по пути `/var/log/syslog`
`requested_mask=r` - означает, что запрошено действия на чтение файла, `denied_mask=r` - означает запрет на чтение файла

**1.2. Переведите профиль `bin.ping` в режим `complain`. Повторите действия из шага 1.1. Что изменилось? Объясните. Какие теперь записи в журнале?**

![Pasted image 20250302214211.png](/img/user/Pasted%20image%2020250302214211.png)
<div style="text-align: center;">
  Рисунок 3 - Перевод bin.ping в режим complain
</div>

Перевод в данное состояние означает, что теперь можно выполнять действия, которые недоступны в режиме `enforce`. И теперь в журнале логов действия будут отображаться с пометкой `ALLOWED`

**1.3. Верните утилиту `ping` на свое место.**

![Pasted image 20250302214233.png](/img/user/Pasted%20image%2020250302214233.png)
<div style="text-align: center;">
  Рисунок 4 - Возвращаем утилиту на место
</div>


![Pasted image 20250302214256.png](/img/user/Pasted%20image%2020250302214256.png)
<div style="text-align: center;">
  Рисунок 5 -  Проверка ping
</div>

Проверяем, что утилита работа корректно


**1.4. Переведите профиль `bin.ping` в режим `enforce`. Попробуйте воспользоваться утилитов (из шага 1.1.) `my_ping`.**

![Pasted image 20250302221153.png](/img/user/Pasted%20image%2020250302221153.png)
<div style="text-align: center;">
  Рисунок 6 - Перевод bin.pin в режим enforce
</div>

Вновь переводим профиль в режим enforce. Снова пытаемся скопировать файл и у получаем ошибку

Объясните, что произошло. Посмотрите журнал, что там за сообщения (относительно этой операции)?

![Pasted image 20250302221209.png](/img/user/Pasted%20image%2020250302221209.png)
<div style="text-align: center;">
  Рисунок 7 - Проверка логов
</div>

Получаем такой же результат, как и в пункте 1.1
### 2. AppArmor на примере Docker

**2.1. Установите Docker**
Создайте группу `docker`, добавьте в нее своего пользователя. При необходимости перезагрузите систему.

![Pasted image 20250302221321.png](/img/user/Pasted%20image%2020250302221321.png)
<div style="text-align: center;">
  Рисунок 8 - Смотрит версию docker
</div>

Docker уже установлен в системе, так как он раньше требовался мне для работы

![Pasted image 20250302221333.png](/img/user/Pasted%20image%2020250302221333.png)
<div style="text-align: center;">
  Рисунок 9 - Создание группы docker
</div>

`sudo usermod -aG docker {user}` - позволяет установить возможность пользователю использовать docker без sudo. `-a` - добавляет пользователя в группу, `-G` - указывает группу

![Pasted image 20250302221343.png](/img/user/Pasted%20image%2020250302221343.png)
<div style="text-align: center;">
  Рисунок 10 - Проверка групп
</div>

Проверяем, что группы установилась корректно


**2.2. Создайте Docker-конетейнер с ubuntu:**

```
docker container run --rm -it --cap-add SYS_ADMIN --security-opt seccomp=unconfined ubuntu sh
```

Что значат ключи: - `--cap-add` - `seccomp=unconfined`

Какой профиль **AppArmor** загружен?

Создайте два новых каталога (внутри контейнера), смонтируйте первый каталог в другой каталог (подробнее, `mount --bind`)

Что происходит?

### 3. Пользовательский профиль AppArmor

**3.1. Скачайте материалы для ЛР из репозитория Docker:**

```
git clone https://github.com/docker/labs.git
cd labs/security/apparmor/wordpress
```

**3.2. Опишите, какие контейнеры предлагается создать (docker-compose.yml). Создайте контейнеры с помощью docker-compose**

**3.3. Проверьте работоспособность WordPress, выбрав язык и установив какие-либо плагины.**

Все ли работает?

**3.4. Удалите созданные контейнеры.**

**3.5. Добавьте wparmor профиль в файл конфигурации.**

Вставьте:

```
security_opt:
    - apparmor=wparmor
```

Вместо закомментированных строк.

Опишите правила в `wparmor`.

**3.6. Отредактируйте файл wparmor так, чтобы запретить использование каталогов в `var/www/html/wp-content` за исключением директории `uploads`. _Спарсите_ новый файл (`apparmor_parse`).**

**3.7. Повторите шаги 3.2. и 3.3. и опишите результат.**

Можете ли вы устанавливать плагины и загружать другой контент?

### 4. Пользовательский профиль AppArmor произвольного приложения

**4.1. Выберите произвольное приложение с открытым исходным кодом (приложение может сразу поставляться в виде docker-образа или вы можете создать образ самостоятельно). Приложение должно быть подобрано таким образом, чтобы было удобно настроить политику AppArmor для него. Разверните приложение, опишите процесс выполнения развертывания.**

**4.2. Придумайте и опишите политику AppArmor, продемонстрируйте ее работу.**